<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Ear Training Game</title>
        <style type="text/css">
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
            .panel-frame {
                position: absolute;
            }
            .menu-button {
                width: 100px;
                height: 30px;
                border: 1px solid #000000;
            }
        </style>
    </head>
    <body onload='game.start()'>
        <script type="text/javascript">

            const defaultInterval = 40;     // measured in milliseconds (FPS:25)
            const defaultCanvasWidth = 800;
            const defaultCanvasHeight = 600;
            const menuButtons = ['New Game', 'Load Game', 'Selet Level', 'Options'];
            const gamePausedButtons = ['Resume', 'Restart', 'Save Game', 'Load Game', 'Options', 'Quit Game'];
            const instruments = ['keyboard', 'piano'];

            var game = {
                canvas: document.createElement('canvas'),
                start: function () {
                    this.canvas.width = defaultCanvasWidth;
                    this.canvas.height = defaultCanvasHeight;
                    this.ctx = this.canvas.getContext('2d');
                    this.canvas.onmousemove = function (e) {
                        let rect = game.canvas.getBoundingClientRect();
                        game.mousePos.x = e.clientX - rect.left;
                        game.mousePos.y = e.clientY - rect.top;
                        // console.log(game.mousePos.x, game.mousePos.y);
                    };
                    this.canvas.onclick = function (e) {
                        game.input.mouseClick = true;
                        // console.log('mouse click');
                    };
                    document.onmousedown = function (e) {
                        game.input.mouseDown = true;
                        // console.log('mouse down');
                    };
                    document.onmouseup = function (e) {
                        game.input.mouseDown = false;
                        // console.log('mouse up');
                    };
                    window.onkeydown = function (e) {
                        game.input.keyDown[e.keyCode] = true;
                    };
                    window.onkeyup = function (e) {
                        game.input.keyDown[e.keyCode] = false;
                    };
                    document.body.appendChild(this.canvas);

                    game.scenes.start('Menu');

                    this.interval = setInterval(gameUpdate, defaultInterval);
                },
                scenes: {
                    children: [],
                    add: function (newScene) {
                        this.children.push(newScene);
                    },
                    get: function (sceneName) {
                        return getFromChildren(sceneName, this.children);
                    },
                    start: function (sceneName) {
                        sceneStart( this.get(sceneName) );
                    },
                    stop: function (sceneName) {
                        sceneStop( this.get(sceneName) );
                    },
                    pause: function (sceneName) {
                        scenePause( this.get(sceneName) );
                    },
                    wake: function (sceneName) {
                        sceneWake( this.get(sceneName) );
                    }
                },
                panels: {
                    children: [],
                    largestZ: 10,
                    add: function (newPanel) {
                        this.children.push(newPanel);
                    },
                    get: function (panelName) {
                        return getFromChildren(panelName, this.children);
                    },
                    on: function (panelName) {
                        panelOn( this.get(panelName) );
                    },
                    off: function (panelName) {
                        panelOff( this.get(panelName) );
                    }
                },
                loadImage: function (name, source) {
                    let img = new Image();
                    img.src = source;
                    this.loaded.images[name] = img;
                },
                loadSprite: function (name, width, height, source) {
                    let img = new Image();
                    img.src = source;
                    this.loaded.sprites[name] = new Sprite(img, width, height);
                },
                getImage: function (name) {
                    return this.loaded.images[name];
                },
                getSprite: function (name) {
                    return this.loaded.sprites[name];
                },
                clearScreen: function () {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                },
                clearLoaded: function () {
                    this.loaded = { image:{}, sprite:{}, data:{} };
                },
                loaded: {
                    images: {},
                    sprites: {},
                    data: {}
                },
                mousePos: {
                    x: null,
                    y: null
                },
                input: {
                    mouseClick: false,
                    mouseDown: false,
                    keyDown: []
                }
            };

            game.scenes.add( {
                name: 'Menu',
                status: 'stopped',          // stopped, running, paused
                preload: function () {
                    game.canvas.style.backgroundImage = 'url(assets/img/menu-page.jpg)';
                    game.loadImage('menu-buttons', 'assets/img/menu-buttons.png');
                    game.loadImage('menu-buttons-hover', 'assets/img/menu-buttons-hover.png');
                },
                create: function () {
                    let buttonSize = {width: 303, height: 47};
                    let buttonsTopPos = {x: 252, y: 280};
                    let intervalY = 65;
                    let amount = 4;
                    let button = [];
                    for (let i = 0; i < amount; i++) {
                        button[i] = {
                            image: game.getImage('menu-buttons'),
                            imageHover: game.getImage('menu-buttons-hover'),
                            width: 303,
                            height: 47,
                            sx: 0,
                            sy: i * buttonSize.height,
                            dx: buttonsTopPos.x,
                            dy: buttonsTopPos.y + (i * intervalY)
                        };
                        button[i].drawArgs = [
                            button[i].image,
                            button[i].sx,
                            button[i].sy,
                            button[i].width,
                            button[i].height,
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                        button[i].drawHoverArgs = [
                            button[i].imageHover,
                            button[i].sx,
                            button[i].sy,
                            button[i].width,
                            button[i].height,
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                        button[i].isHoverArgs = [
                            'rect',
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                    }
                    game.loaded.data.menuButton = button;
                },
                update: function () {
                    let mb = game.loaded.data.menuButton;
                    for (let i = 0; i < mb.length; i++) {
                        if (isHover.apply(null, mb[i].isHoverArgs)) {
                            game.ctx.drawImage.apply(game.ctx, mb[i].drawHoverArgs);
                        } else {
                            game.ctx.drawImage.apply(game.ctx, mb[i].drawArgs);
                        }
                    }
                }
            } );

            game.scenes.add( {
                name: 'Game',
                status: 'stopped',
                preload: function () {

                },
                create: function () {

                },
                update: function () {

                }
            } );


            function gameUpdate () {
                for (let scene of game.scenes.children) {
                    if (scene.status == 'running') {
                        scene.update();
                    }
                }
            }


            // ========= Tools function ==========

            function getFromChildren (name, children) {
                return children.find( function (elem) {
                    return elem.name == name;
                } );
            }
            function isHover (shape, ...args) {
                let pos = game.mousePos;
                let x = args[0];
                let y = args[1];
                if (shape == 'rect') {             // [x, y, width, height]
                    let testtest = x + args[2];
                    let y2 = y + args[3];
                    if (pos.x >= x && pos.x <= testtest && pos.y >= y && pos.y <= y2) {
                        return true;
                    } else {
                        return false;
                    }
                }
                else if (shape == 'square') {     // [x, y, length_of_a_side]
                    let testtest = x + args[2];
                    let y2 = y + args[2];
                    if (pos.x >= x && pos.x <= testtest && pos.y >= y && pos.y <= y2) {
                        return true;
                    } else {
                        return false;
                    }
                }
                else if (shape == 'curcle') {     // [x, y, radius]
                    let r = args[2];
                    let distanceSq = Math.pow(pos.x - x, 2) + Math.pow(pos.y - y, 2);
                    if (distamceSq < Math.pow(r, 2)) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }

            // ===================================

            function sceneStart (scene) {
                console.log(scene.name + ' scene preloading..');
                scene.preload();
                console.log(scene.name + ' scene creating..');
                scene.create();
                console.log(scene.name + ' scene running...');
                scene.status = 'running';
            }
            function sceneStop (scene) {
                console.log(scene.name + ' scene stopped');
                scene.status = 'stopped';
            }
            function scenePause (scene) {
                console.log(scene.name + ' scene paused');
                scene.status = 'paused';
            }
            function sceneWake (scene) {
                if (scene.status == 'paused') {
                    console.log(scene.name + ' scene waked');
                    scene.status = 'running';
                } else {
                    console.log('[ERROR] ' + scene.name + ' scene not paused');
                }
            }
            function panelOn (panel) {
                panel.preload();
                panel.create();
                panel.status = 'on';
            }
            function panelOff (panel) {
                panel.status = 'off';
            }

            function Sprite (image, width, height) {
                this.image = image;
                this.width = width;
                this.height = height;
                this.amount = [ image.width/width, image.height/height ];
            }
        </script>
    </body>
</html>
