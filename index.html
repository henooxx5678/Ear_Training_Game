<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Ear Training Game</title>
        <style type="text/css">
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
            .panel-frame {
                position: absolute;
            }
            .menu-button {
                width: 100px;
                height: 30px;
                border: 1px solid #000000;
            }
        </style>
    </head>
    <body onload='game.start()'>
        <script type="text/javascript">

            const defaultInterval = 40;     // measured in milliseconds (FPS:25)
            const defaultCanvasWidth = 800;
            const defaultCanvasHeight = 600;
            const menuButtons = ['New Game', 'Load Game', 'Selet Level', 'Options'];
            const gamePausedButtons = ['Resume', 'Restart', 'Save Game', 'Load Game', 'Options', 'Quit Game'];
            const instruments = ['keyboard', 'piano'];

            var game = {
                canvas: document.createElement('canvas'),
                start: function () {
                    this.canvas.width = defaultCanvasWidth;
                    this.canvas.height = defaultCanvasHeight;
                    this.ctx = this.canvas.getContext('2d');
                    this.canvas.onmousemove = function (e) {
                        let rect = game.canvas.getBoundingClientRect();
                        game.mousePos.x = e.clientX - rect.left;
                        game.mousePos.y = e.clientY - rect.top;
                        // console.log(game.mousePos.x, game.mousePos.y);
                    };
                    this.canvas.onclick = function (e) {
                        game.input.mouseClick = true;
                        // console.log('mouse click');
                    };
                    document.onmousedown = function (e) {
                        game.input.mouseDown = true;
                        // console.log('mouse down');
                    };
                    document.onmouseup = function (e) {
                        game.input.mouseDown = false;
                        // console.log('mouse up');
                    };
                    window.onkeydown = function (e) {
                        game.input.key[e.keyCode] = true;
                    };
                    window.onkeyup = function (e) {
                        game.input.key[e.keyCode] = false;
                    };
                    document.body.appendChild(this.canvas);

                    game.scenes.start('Menu');

                    this.interval = setInterval(gameUpdate, defaultInterval);
                },
                clear: function () {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                },
                scenes: {
                    children: [],
                    add: function (newScene) {
                        this.children.push(newScene);
                    },
                    get: function (sceneName) {
                        return getFromChildren(sceneName, this.children);
                    },
                    start: function (sceneName) {
                        sceneStart( this.get(sceneName) );
                    },
                    stop: function (sceneName) {
                        sceneStop( this.get(sceneName) );
                    },
                    pause: function (sceneName) {
                        scenePause( this.get(sceneName) );
                    },
                    wake: function (sceneName) {
                        sceneWake( this.get(sceneName) );
                    }
                },
                panels: {
                    children: [],
                    largestZ: 10,
                    add: function (newPanel) {
                        this.children.push(newPanel);
                    },
                    get: function (panelName) {
                        return getFromChildren(panelName, this.children);
                    },
                    on: function (panelName) {
                        panelOn( this.get(panelName) );
                    },
                    off: function (panelName) {
                        panelOff( this.get(panelName) );
                    }
                },
                loaded: {
                    image: {},
                    sprite: {}
                },
                mousePos: {
                    x: null,
                    y: null
                },
                input: {
                    mouseClick: false,
                    mouseDown: false,
                    keyDown: []
                }
            };

            game.scenes.add( {
                name: 'Menu',
                status: 'stopped',          // stopped, running, paused
                preload: function () {
                    game.canvas.style.backgroundImage = 'url(assets/img/menu-page.jpg)';
                },
                create: function () {

                },
                update: function () {

                }
            } );

            game.scenes.add( {
                name: 'Game',
                status: 'stopped',
                preload: function () {

                },
                create: function () {

                },
                update: function () {

                }
            } );


            function gameUpdate () {
                for (let scene of game.scenes.children) {
                    if (scene.status == 'running') {
                        scene.update();
                    }
                }
            }


            function getFromChildren(name, children) {
                return children.find( function (elem) {
                    return elem.name == name;
                } );
            }

            function sceneStart (scene) {
                console.log(scene.name + ' scene preloading..');
                scene.preload();
                console.log(scene.name + ' scene creating..');
                scene.create();
                console.log(scene.name + ' scene running...');
                scene.status = 'running';
            }
            function sceneStop (scene) {
                console.log(scene.name + ' scene stopped');
                scene.status = 'stopped';
            }
            function scenePause (scene) {
                console.log(scene.name + ' scene paused');
                scene.status = 'paused';
            }
            function sceneWake (scene) {
                if (scene.status == 'paused') {
                    console.log(scene.name + ' scene waked');
                    scene.status = 'running';
                } else {
                    console.log('[ERROR] ' + scene.name + ' scene not paused');
                }
            }
            function panelOn (panel) {
                panel.preload();
                panel.create();
                panel.status = 'on';
            }
            function panelOff (panel) {
                panel.status = 'off';
            }
        </script>
    </body>
</html>
