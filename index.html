<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Ear Training Game</title>
        <style type="text/css">
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
        </style>
    </head>
    <body onload='gameStart()'>
        <script type="text/javascript">

            const config = {
                interval: 40,       // measured in milliseconds (FPS:25)
                width: 800,
                height: 600,
                instruments: [
                    'keyboard',
                    'piano'
                ],
                menuScene: {
                    buttons: {
                        width: 303,
                        height: 47,
                        leftTop: { x: 252, y: 280 },
                        intervalY: 65,
                        names: [
                            'New Game',
                            'Load Game',
                            'Select Level',
                            'Options'
                        ]
                    }
                },
                gameScene: {
                    enemy: {
                        hpBar: {
                            color: ['#00cf00', 'red'],       // HP Remained, HP Lost
                            filter: ['drop-shadow(1px 2px 2px #333333)', 'none'],
                            rect: {
                                x: 200,
                                y: 10,
                                width: 400,
                                height: 20
                            }
                        }
                    },
                    player: {
                        hpBar: {
                            color: ['#00cf00', 'red'],       // HP Remained, HP Lost
                            filter: ['drop-shadow(1px 2px 2px #333333)', 'none'],
                            rect: {
                                x: 200,
                                y: 570,
                                width: 400,
                                height: 20
                            }
                        }
                    },
                    pausedPanel: {
                        buttons: {
                            width: 0,
                            height: 0,
                            leftTop: {},
                            intervalY: 0,
                            names: [
                                'Resume',
                                'Restart',
                                'Save Game',
                                'Load Game',
                                'Options',
                                'Quit Game'
                            ]
                        }
                    }
                }
            }

            var game = {
                canvas: document.createElement('canvas'),
                start: function () {
                    this.canvas.width = config.width;
                    this.canvas.height = config.height;
                    this.ctx = this.canvas.getContext('2d');
                    this.canvas.onmousemove = function (e) {
                        let rect = game.canvas.getBoundingClientRect();
                        game.mousePos.x = e.clientX - rect.left;
                        game.mousePos.y = e.clientY - rect.top;
                        // console.log(game.mousePos.x, game.mousePos.y);
                    };
                    this.canvas.onclick = function (e) {
                        game.input.mouseClick = true;
                        // console.log('mouse click');
                    };
                    document.onmousedown = function (e) {
                        game.input.mouseDown = true;
                        // console.log('mouse down');
                    };
                    document.onmouseup = function (e) {
                        game.input.mouseDown = false;
                        // console.log('mouse up');
                    };
                    window.onkeydown = function (e) {
                        game.input.keyDown[e.keyCode] = true;
                    };
                    window.onkeyup = function (e) {
                        game.input.keyDown[e.keyCode] = false;
                    };
                    document.body.appendChild(this.canvas);

                    game.scenes.start('Menu');

                    this.interval = setInterval(gameUpdate, config.interval);
                },
                scenes: {
                    children: [],
                    add: function (newScene) {
                        this.children.push(newScene);
                    },
                    get: function (sceneName) {
                        return getFromChildren(sceneName, this.children);
                    },
                    start: function (sceneName) {
                        sceneStart( this.get(sceneName) );
                    },
                    stop: function (sceneName) {
                        sceneStop( this.get(sceneName) );
                    },
                    pause: function (sceneName) {
                        scenePause( this.get(sceneName) );
                    },
                    wake: function (sceneName) {
                        sceneWake( this.get(sceneName) );
                    }
                },
                loadImage: function (name, source) {
                    let img = new Image();
                    img.src = source;
                    this.loaded.images[name] = img;
                },
                loadSprite: function (name, width, height, source) {
                    let img = new Image();
                    img.src = source;
                    this.loaded.sprites[name] = new Sprite(img, width, height);
                },
                getImage: function (name) {
                    return this.loaded.images[name];
                },
                getSprite: function (name) {
                    return this.loaded.sprites[name];
                },
                clearScreen: function () {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                },
                clearLoaded: function () {
                    this.loaded = { images:{}, sprites:{}, data:{} };
                },
                loaded: {
                    images: {},
                    sprites: {},
                    data: {}
                },
                mousePos: {
                    x: null,
                    y: null
                },
                input: {
                    mouseClick: false,
                    mouseDown: false,
                    keyDown: []
                }
            };

            game.scenes.add( {
                name: 'Menu',
                status: 'stopped',          // stopped, running, paused
                page: 'beginning',
                preload: function () {
                    game.loadImage('scene-bg', 'assets/img/menu-scene.jpg');
                    game.loadImage('menu-buttons', 'assets/img/menu-buttons.png');
                    game.loadImage('menu-buttons-hover', 'assets/img/menu-buttons-hover.png');
                },
                create: function () {
                    let menuButtons = config.menuScene.buttons;
                    let button = [];
                    for (let i = 0; i < menuButtons.names.length; i++) {
                        button[i] = {
                            name: config.menuScene.buttons.names[i],
                            image: game.getImage('menu-buttons'),
                            imageHover: game.getImage('menu-buttons-hover'),
                            width: menuButtons.width,
                            height: menuButtons.height,
                            sx: 0,
                            sy: i * menuButtons.height,
                            dx: menuButtons.leftTop.x,
                            dy: menuButtons.leftTop.y + (i * menuButtons.intervalY)
                        };
                        button[i].drawArgs = [
                            button[i].image,
                            button[i].sx,
                            button[i].sy,
                            button[i].width,
                            button[i].height,
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                        button[i].drawHoverArgs = [
                            button[i].imageHover,
                            button[i].sx,
                            button[i].sy,
                            button[i].width,
                            button[i].height,
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                        button[i].isHoverArgs = [
                            'rect',
                            button[i].dx,
                            button[i].dy,
                            button[i].width,
                            button[i].height
                        ];
                    }
                    game.loaded.data.menuButton = button;
                },
                update: function () {
                    let bgImg = game.getImage('scene-bg');
                    let menuButton = game.loaded.data.menuButton;
                    let onClick = false;

                    game.clearScreen();
                    if (this.page == 'beginning') {
                        game.ctx.drawImage(bgImg, 0, 0);
                        for (let i = 0; i < menuButton.length; i++) {
                            if (isHover.apply(null, menuButton[i].isHoverArgs)) {
                                game.ctx.drawImage.apply(game.ctx, menuButton[i].drawHoverArgs);
                                if (game.input.mouseClick) {
                                    game.input.mouseClick = false;
                                    onClick = menuButton[i].name;
                                }
                            } else {
                                game.ctx.drawImage.apply(game.ctx, menuButton[i].drawArgs);
                            }
                        }
                    } else {        // blur background
                        game.ctx.filter = 'blur(5px)';
                        game.ctx.drawImage(bgImg, 0, 0);
                        game.ctx.filter = 'none';
                        game.ctx.fillStyle = 'rgba(225,225,225,0.5)';
                        game.ctx.fillRect(0, 0, bgImg.width, bgImg.height);
                        if (this.page == 'load-game') {

                        } else if (this.page == 'select-level') {

                        } else if (this.page == 'options') {

                        }
                    }


                    if (onClick) {
                        buttonClick(this, onClick);
                    }
                }
            } );

            game.scenes.add( {
                name: 'Game',
                status: 'stopped',
                panels: new Panels(),
                preload: function () {
                    game.loadImage('scene-bg', 'assets/img/game-scene.jpg');
                },
                create: function () {
                    let enemy = config.gameScene.enemy;
                    let player = config.gameScene.player;

                    game.loaded.data.enemy = {
                        hp: 100,
                        maxHp: 100,
                        hpBar: {
                            color: config.gameScene.enemy.hpBar.color[0],
                            filter: config.gameScene.enemy.hpBar.filter[0],
                            rect: Object.assign({}, config.gameScene.enemy.hpBar.rect)
                        },
                        maxHpBar: {
                            color: config.gameScene.enemy.hpBar.color[1],
                            filter: config.gameScene.enemy.hpBar.filter[1],
                            rect: Object.assign({}, config.gameScene.enemy.hpBar.rect)
                        }
                    };
                    game.loaded.data.enemy.hpBar.rect.y -= 1;

                    game.loaded.data.player = {
                        hp: 100,
                        maxHp: 100,
                        hpBar: {
                            color: config.gameScene.player.hpBar.color[0],
                            filter: config.gameScene.player.hpBar.filter[0],
                            rect: Object.assign({}, config.gameScene.player.hpBar.rect)
                        },
                        maxHpBar: {
                            color: config.gameScene.player.hpBar.color[1],
                            filter: config.gameScene.player.hpBar.filter[1],
                            rect: Object.assign({}, config.gameScene.player.hpBar.rect)
                        }
                    };
                    game.loaded.data.player.hpBar.rect.y -= 1;
                },
                update: function () {
                    let enemy = game.loaded.data.enemy;
                    let player = game.loaded.data.player;

                    game.clearScreen();

                    enemy.hpBar.rect.width = enemy.maxHpBar.rect.width * enemy.hp / enemy.maxHp;
                    player.hpBar.rect.width = player.maxHpBar.rect.width * player.hp / player.maxHp;
                    game.ctx.drawImage(game.getImage('scene-bg'), 0, 0);

                    // Enemy's HP-bar
                    game.ctx.fillStyle = enemy.maxHpBar.color;
                    game.ctx.filter = enemy.maxHpBar.filter;
                    game.ctx.fillRect.apply(game.ctx, Object.values(enemy.maxHpBar.rect));
                    game.ctx.fillStyle = enemy.hpBar.color;
                    game.ctx.filter = enemy.hpBar.filter;
                    game.ctx.fillRect.apply(game.ctx, Object.values(enemy.hpBar.rect));
                    // Player's HP-bar
                    game.ctx.fillStyle = player.maxHpBar.color;
                    game.ctx.filter = player.maxHpBar.filter;
                    game.ctx.fillRect.apply(game.ctx, Object.values(player.maxHpBar.rect));
                    game.ctx.fillStyle = player.hpBar.color;
                    game.ctx.filter = player.hpBar.filter;
                    game.ctx.fillRect.apply(game.ctx, Object.values(player.hpBar.rect));
                    game.ctx.filter = 'none';
                }
            } );


            function gameStart () {
                game.start();
            }
            function gameUpdate () {
                for (let scene of game.scenes.children) {
                    if (scene.status == 'running') {
                        scene.update();
                    }
                }
            }

            function buttonClick (scene, name) {
                console.log('\"' + name + '\"' + ' clicked');
                if (scene.name == 'Menu') {
                    if (name == 'New Game') {
                        game.scenes.stop('Menu');
                        game.scenes.start('Game');
                    }
                    else if (name == 'Load Game') {
                        scene.page = 'load-game';
                    }
                    else if (name == 'Select Level') {
                        scene.page = 'select-level';
                    }
                    else if (name == 'Options') {
                        scene.page = 'options';
                    }
                }
                else if (name == 'Game') {

                }
            }


            // ========= Tools function ==========

            function getFromChildren (name, children) {
                return children.find( function (elem) {
                    return elem.name == name;
                } );
            }
            function isHover (shape, ...args) {
                let pos = game.mousePos;
                let x = args[0];
                let y = args[1];
                if (shape == 'rect') {             // [x, y, width, height]
                    let testtest = x + args[2];
                    let y2 = y + args[3];
                    if (pos.x >= x && pos.x <= testtest && pos.y >= y && pos.y <= y2) {
                        return true;
                    } else {
                        return false;
                    }
                }
                else if (shape == 'square') {     // [x, y, length_of_a_side]
                    let testtest = x + args[2];
                    let y2 = y + args[2];
                    if (pos.x >= x && pos.x <= testtest && pos.y >= y && pos.y <= y2) {
                        return true;
                    } else {
                        return false;
                    }
                }
                else if (shape == 'curcle') {     // [x, y, radius]
                    let r = args[2];
                    let distanceSq = Math.pow(pos.x - x, 2) + Math.pow(pos.y - y, 2);
                    if (distamceSq < Math.pow(r, 2)) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }

            // ===================================

            function sceneStart (scene) {
                console.log(scene.name + ' scene preloading..');
                scene.preload();
                console.log(scene.name + ' scene creating..');
                scene.create();
                console.log(scene.name + ' scene running...');
                scene.status = 'running';
            }
            function sceneStop (scene) {
                console.log(scene.name + ' scene stopped');
                scene.status = 'stopped';
                game.clearScreen();
                game.clearLoaded();
                game.canvas.style.backgroundImage = '';
            }
            function scenePause (scene) {
                console.log(scene.name + ' scene paused');
                scene.status = 'paused';
            }
            function sceneWake (scene) {
                if (scene.status == 'paused') {
                    console.log(scene.name + ' scene waked');
                    scene.status = 'running';
                } else {
                    console.log('[ERROR] ' + scene.name + ' scene not paused');
                }
            }

            function panelsInit (panels) {
                for (let panel of panels) {
                    panel.preload();
                    panel.create();
                }
            }
            function panelOn (panel) {
                panel.status = 'on';
            }
            function panelOff (panel) {
                panel.status = 'off';
            }

            function Panels () {
                this.children = [];
                this.init = function () {
                    panelsInit(this.children);
                };
                this.add = function (newPanel) {
                    this.children.push(newPanel);
                };
                this.get = function (panelName) {
                    return getFromChildren(panelName, this.children)
                };
                this.on = function (panelName) {
                    panelOn(this.get(panelName));
                };
                this.off = function (panelName) {
                    panelOff(this.get(panelName));
                };
            }

            function Sprite (image, width, height) {
                this.image = image;
                this.width = width;
                this.height = height;
                this.amount = [ image.width/width, image.height/height ];
            }
        </script>
    </body>
</html>
